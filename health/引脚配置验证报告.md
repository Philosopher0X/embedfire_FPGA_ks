# MAX30102引脚配置验证报告

## 日期: 2025-12-22

## 1. 引脚映射对比

### 根据《征途引脚绑定映射表.xlsx》的正确配置：

| 功能 | 信号名 | FPGA引脚 | health.qsf配置 | 状态 |
|------|--------|----------|----------------|------|
| **I2C通信** |
| I2C时钟 | I2C1_SCL | PIN_P15 | PIN_P15 | ✅ 正确 |
| I2C数据 | I2C1_SDA | PIN_N14 | PIN_N14 | ✅ 正确 |
| **摄像头接口** |
| 摄像头数据7 | CAM_D7 | PIN_L13 | PIN_L13 (max_int) | ✅ 正确 |
| **LED指示灯** |
| LED1 | LED1 | PIN_L7 | PIN_L7 (led[0]) | ✅ 已修正 |
| LED2 | LED2 | PIN_M6 | PIN_M6 (led[1]) | ✅ 已修正 |
| LED3 | LED3 | PIN_P3 | PIN_P3 (led[2]) | ✅ 已修正 |
| LED4 | LED4 | PIN_N3 | PIN_N3 (led[3]) | ✅ 已修正 |
| **数码管(74HC595)** |
| 移位时钟 | LEDSD_SHCP | PIN_B1 | PIN_B1 (shcp) | ✅ 正确 |
| 锁存时钟 | LEDSD_STCP | PIN_K9 | PIN_K9 (stcp) | ✅ 正确 |
| 串行数据 | LEDSD_DS | PIN_R1 | PIN_R1 (ds) | ✅ 正确 |
| 输出使能 | LEDSD_BL | PIN_L11 | PIN_L11 (oe) | ✅ 正确 |

## 2. MAX30102硬件连接

### 野火小智心率血氧检测模块接口：

```
MAX30102模块      开发板信号      FPGA引脚      说明
-----------      ----------     ----------    -----
VCC              3.3V           -             3.3V供电(重要!)
GND              GND            -             地线
SCL              I2C1_SCL       PIN_P15       I2C时钟(板载上拉4.7kΩ)
SDA              I2C1_SDA       PIN_N14       I2C数据(板载上拉4.7kΩ)
INT              CAM_D7         PIN_L13       中断输出(低电平有效)
```

**注意事项：**
1. ⚠️ MAX30102必须使用3.3V供电，不能使用5V！
2. ✅ 板载I2C接口已有4.7kΩ上拉电阻，无需外接
3. ✅ INT引脚复用摄像头接口的CAM_D7
4. ✅ I2C通信速率：100kHz

## 3. LED状态指示说明

### LED功能定义（top_max30102.v）：

```verilog
led[0] <= init_done;   // LED1(L7)：初始化完成指示
led[1] <= error;       // LED2(M6)：错误指示
led[2] <= data_valid;  // LED3(P3)：数据有效（应闪烁）
led[3] <= hr_valid;    // LED4(N3)：心率计算完成（10秒一次）
```

### LED状态诊断：

#### 正常工作状态：
- ✅ LED1(L7)常亮 = MAX30102初始化成功
- ✅ LED2(M6)熄灭 = 无I2C通信错误
- ✅ LED3(P3)以100Hz闪烁 = 正在接收FIFO数据
- ✅ LED4(N3)每10秒闪一次 = 心率计算周期完成

#### 异常状态分析：

| LED状态 | 问题原因 | 解决方法 |
|---------|---------|----------|
| LED1不亮 | I2C通信失败/初始化失败 | 检查SCL/SDA接线和电源 |
| LED2常亮 | I2C ACK错误 | 检查I2C地址0x57和连接 |
| LED1亮但LED3不闪 | FIFO无数据 | 检查传感器是否被遮挡 |
| 全部不亮 | 供电问题/程序未运行 | 检查电源和下载.sof |

## 4. 数码管显示格式

### 显示布局（6位数码管）：
```
位置:     6    5    4    3    2    1
显示:   [温度十][温度个][ - ][心率百][心率十][心率个]
示例:     2    5    -    0    7    2
含义:   25度温度     -    72次/分心率
```

### 当前问题：
- 显示"0.0.0.0.0"表示所有数据为0
- 第4位已修改为显示"-"(横杠)
- temp_display初始值=25度(应显示25)
- 如果显示全0，说明程序初始化失败

## 5. 可能的问题原因

### 根据"数码管显示全0"症状分析：

#### 最可能的问题：
1. **I2C通信未建立**
   - 原因：SCL/SDA接线错误
   - 现象：LED1不亮，数码管显示0
   - 解决：检查P15(SCL)和N14(SDA)是否正确连接

2. **MAX30102供电不足**
   - 原因：使用5V供电或供电电流不足
   - 现象：I2C通信超时，LED2可能亮
   - 解决：确认使用稳定的3.3V电源

3. **引脚配置错误(已修复)**
   - 原因：LED引脚之前配置错误
   - 现象：无法通过LED观察状态
   - 解决：已更新为正确的L7/M6/P3/N3

4. **传感器未接触皮肤**
   - 原因：LED电流设置正常但无信号输入
   - 现象：LED1/LED2正常，LED3不闪烁
   - 解决：手指按压传感器表面

## 6. 调试步骤

### Step 1: 硬件检查
1. ✅ 用万用表测量MAX30102的VCC引脚：应为3.3V
2. ✅ 用万用表测量GND：应与开发板GND导通
3. ✅ 检查SCL连接到P15引脚
4. ✅ 检查SDA连接到N14引脚
5. ✅ 检查INT连接到L13引脚

### Step 2: 重新编译下载
```bash
# 在Quartus II中：
1. Processing → Start Compilation
2. 等待编译完成(约3-5分钟)
3. Tools → Programmer
4. 下载output_files/health.sof到FPGA
```

### Step 3: 观察LED状态
```
上电后2秒内观察：
- LED1应该点亮（初始化完成）
- LED2应该熄灭（无错误）
- 数码管应显示"25-000"（默认温度25度，心率0）
```

### Step 4: 传感器测试
```
1. 将手指轻轻按压在MAX30102红色LED上
2. 观察MAX30102上的红色LED是否亮起
3. 观察FPGA板LED3是否开始闪烁(100Hz)
4. 等待10秒观察数码管温度和心率变化
```

## 7. I2C通信参数

### MAX30102 I2C配置（max30102_driver.v）：

```verilog
// I2C从机地址
SLAVE_ADDR = 7'h57  // 7位地址

// I2C时钟频率
SCL_FREQ = 100kHz   // 周期10us

// 寄存器地址
REG_MODE_CONFIG  = 0x09  // 模式配置
REG_SPO2_CONFIG  = 0x0A  // SpO2配置  
REG_LED1_PA      = 0x0C  // RED LED电流
REG_LED2_PA      = 0x0D  // IR LED电流
REG_FIFO_DATA    = 0x07  // FIFO数据
REG_TEMP_INT     = 0x1F  // 温度整数
REG_TEMP_FRAC    = 0x20  // 温度小数
```

### 初始化序列：
```
1. SOFT_RESET    : 写0x09 = 0x40
2. FIFO_CONFIG   : 写0x08 = 0x4F  
3. MODE_CONFIG   : 写0x09 = 0x03 (SpO2模式)
4. SPO2_CONFIG   : 写0x0A = 0x27 (100Hz, 18bit)
5. LED1_PA (RED) : 写0x0C = 0x50 (约12.5mA)
6. LED2_PA (IR)  : 写0x0D = 0x50 (约12.5mA)
```

## 8. 示波器测试要点

### 如有示波器，建议测量：

**I2C时钟波形（SCL - PIN_P15）：**
- 频率：100kHz (周期10us)
- 电平：0V/3.3V
- 波形：方波，上升沿陡峭

**I2C数据波形（SDA - PIN_N14）：**
- 电平：0V/3.3V
- 特征：在SCL高电平时保持稳定
- 每次传输：9个时钟周期(8位数据+1位ACK)

**中断信号（INT - PIN_L13）：**
- 空闲：3.3V高电平
- 有数据：拉低至0V
- 频率：约100Hz(与采样率一致)

## 9. 总结

### 已修复的问题：
✅ LED引脚配置从错误的A15/A13/B13/A11改为正确的L7/M6/P3/N3
✅ seg_data_6第4位从显示"0"改为显示"-"(横杠)
✅ I2C/INT/数码管引脚配置确认正确

### 待验证的问题：
⚠️ MAX30102硬件连接(特别是供电电压)
⚠️ I2C通信是否建立成功
⚠️ 初始化是否完成(观察LED1状态)

### 下一步操作：
1. **立即重新编译工程**（LED引脚已修正）
2. **下载.sof文件到FPGA**
3. **观察LED1状态**判断初始化是否成功
4. **反馈LED状态**以便进一步诊断

---
*文档生成时间: 2025-12-22*
*FPGA: Altera Cyclone IV EP4CE10F17C8*
*开发板: 野火征途Pro*
