# 数码管显示更新说明

## 显示布局

数码管现在显示：**温度(2位) + 空位 + 心率(3位)**

```
┌──────┬──────┬──────┬──────┬──────┬──────┐
│  6   │  5   │  4   │  3   │  2   │  1   │
├──────┼──────┼──────┼──────┼──────┼──────┤
│温度  │温度  │      │心率  │心率  │心率  │
│十位  │个位  │ 空   │百位  │十位  │个位  │
└──────┴──────┴──────┴──────┴──────┴──────┘

示例显示: 25  078
         ↑↑  ↑↑↑
         温度 心率
         25°C 78BPM
```

## 功能说明

### 温度显示（前2位）
- **数据源**: MAX30102内置温度传感器
- **更新频率**: 每1秒更新一次
- **显示范围**: 0-99°C
- **默认值**: 25°C（初始化前）

### 心率显示（后3位）
- **数据源**: IR通道峰值检测
- **更新频率**: 每10秒计算一次
- **显示范围**: 0-255 BPM
- **计算方法**: 10秒内峰值数 × 6

## 代码修改内容

### 1. max30102_driver.v
- ✅ 添加温度读取输出端口：`temp_int[7:0]`, `temp_frac[3:0]`, `temp_valid`
- ✅ 添加温度读取状态：`READ_TEMP_INT`, `READ_TEMP_FRAC`
- ✅ 添加温度定时器：每1秒读取一次温度
- ✅ 温度寄存器地址：`0x1F`(整数), `0x20`(小数)

### 2. top_max30102.v
- ✅ 添加温度信号连接
- ✅ 添加温度显示寄存器：`temp_display[7:0]`
- ✅ 修改数码管显示格式：温度(2位) + 空位 + 心率(3位)
- ✅ 分离温度和心率的BCD转换

## 使用说明

### 正常工作流程
1. **上电初始化**（1秒）
   - 数码管显示默认温度25°C

2. **初始化完成**（LED0亮）
   - 开始读取温度（每秒一次）
   - 前2位显示实际温度

3. **手指放上**
   - LED2闪烁（数据采集）
   - 后3位在10秒后显示心率

4. **持续工作**
   - 温度持续更新（每1秒）
   - 心率持续更新（每10秒）

### 显示示例

| 显示内容 | 含义 |
|---------|------|
| `25  000` | 温度25°C，心率未计算 |
| `26  078` | 温度26°C，心率78BPM |
| `37  120` | 温度37°C，心率120BPM |
| `99  255` | 温度99°C，心率255BPM（最大值）|

## 温度读取说明

### MAX30102温度传感器
- **精度**: ±1°C
- **范围**: -40°C ~ +85°C
- **用途**: 监测传感器工作温度
- **注意**: 
  - 测量的是传感器芯片温度，不是人体温度
  - 手指接触会使温度略微上升（正常现象）
  - 可用于判断传感器是否正常工作

### 预期温度范围
- **室温环境**: 20-30°C
- **手指接触后**: 30-35°C（取决于环境和接触时间）
- **异常高温**: >40°C 可能是传感器故障或过热

## 调试信息

### SignalTap监测信号（温度相关）
```verilog
temp_int[7:0]       // 温度整数部分（原始值）
temp_frac[3:0]      // 温度小数部分
temp_valid          // 温度数据有效标志
temp_display[7:0]   // 显示的温度值
temp_timer[31:0]    // 温度读取计时器
state              // 状态机（观察READ_TEMP_INT/FRAC状态）
```

### 故障排查

**问题1：温度一直显示25°C**
- 原因：温度未成功读取或初始化未完成
- 检查：
  - LED0是否点亮（初始化完成）
  - 使用SignalTap查看`temp_valid`信号
  - 检查状态机是否进入`READ_TEMP_INT`状态

**问题2：温度显示异常（过高或过低）**
- 原因：I2C通信错误或传感器故障
- 检查：
  - LED1是否点亮（错误指示）
  - 查看I2C ACK信号
  - 尝试重新上电

**问题3：温度不更新**
- 原因：温度定时器未工作
- 检查：
  - 使用SignalTap监测`temp_timer`是否递增
  - 确认状态机周期性进入温度读取状态

## 性能说明

### 系统资源占用
- 增加资源：约50个逻辑单元（LE）
- 主要用于：
  - 温度定时器（32位计数器）
  - 温度数据寄存器
  - BCD转换逻辑

### 时序影响
- **温度读取**: 不影响心率采集
- **I2C操作**: 温度读取和FIFO读取串行执行
- **优先级**: FIFO中断优先于温度读取

## 配置选项

### 修改温度读取频率
在`max30102_driver.v`中修改：
```verilog
// 当前：每1秒读取（50MHz时钟）
if (temp_timer >= 50_000_000)

// 改为每2秒读取
if (temp_timer >= 100_000_000)

// 改为每5秒读取  
if (temp_timer >= 250_000_000)
```

### 禁用温度显示
如需禁用温度显示，在`top_max30102.v`中修改：
```verilog
assign seg_data_6 = {
    4'd0,           // 第6位：空
    4'd0,           // 第5位：空
    4'd0,           // 第4位：空
    hr_bcd_hun,     // 第3位：心率百位
    hr_bcd_ten,     // 第2位：心率十位
    hr_bcd_one      // 第1位：心率个位
};
```

## 版本历史

- **V1.1** (2025-12-22)
  - ✅ 添加温度读取功能
  - ✅ 修改数码管显示：温度(2位) + 心率(3位)
  - ✅ 温度每秒更新一次

- **V1.0** (2025-12-22)
  - 初始版本：仅心率显示

---
**更新日期**: 2025-12-22  
**版本**: V1.1
