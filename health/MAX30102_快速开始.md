# MAX30102 FPGA驱动 - 快速开始指南

## 📋 已完成的配置

### 1. 项目文件
- ✅ `i2c_master.v` - I2C主控制器（100kHz）
- ✅ `max30102_driver.v` - MAX30102驱动控制器
- ✅ `top_max30102.v` - 顶层模块
- ✅ `health.qsf` - 已更新项目配置

### 2. 引脚分配（已配置）

| 功能 | FPGA引脚 | 说明 |
|------|---------|------|
| **系统** | | |
| sys_clk | PIN_E1 | 50MHz时钟 |
| sys_rst_n | PIN_M15 | 复位按钮 |
| **MAX30102** | | |
| max_scl | PIN_P15 | I2C时钟（板载I2C1_SCL，带上拉） |
| max_sda | PIN_N14 | I2C数据（板载I2C1_SDA，带上拉） |
| max_int | PIN_L13 | 中断信号（CAM_D7） |
| **LED指示** | | |
| led[0] | PIN_A15 | 初始化完成 |
| led[1] | PIN_A13 | 错误指示 |
| led[2] | PIN_B13 | 数据采集中 |
| led[3] | PIN_A11 | 心率有效 |
| **数码管** | | |
| shcp | PIN_B1 | 74HC595移位时钟 |
| stcp | PIN_K9 | 74HC595存储时钟 |
| ds | PIN_R1 | 74HC595数据 |
| oe | PIN_L11 | 输出使能 |

## 🔌 硬件连接

### MAX30102模块连接
```
MAX30102模块    →    FPGA开发板
───────────────────────────────
3V3             →    3.3V
GND             →    GND
SCL             →    PIN_P15 (板载I2C1_SCL，已有上拉)
SDA             →    PIN_N14 (板载I2C1_SDA，已有上拉)
INT             →    PIN_L13 (CAM_D7)
```

**⚠️ 重要提示**：
1. 使用板载I2C接口，已有上拉电阻，无需外接
2. INT引脚使用摄像头接口的D7引脚
3. 确保3.3V供电稳定，电流充足

## 🚀 编译和下载步骤

### 1. 打开Quartus项目
```
文件路径: health/health.qpf
```

### 2. 检查项目设置
- 顶层实体：`top_max30102` ✅
- 器件型号：EP4CE10F17C8 ✅
- 引脚分配：已完成 ✅

### 3. 编译项目
1. 点击 Processing → Start Compilation
2. 或按快捷键 Ctrl+L
3. 等待编译完成（约2-5分钟）

### 4. 下载到FPGA
1. 连接USB Blaster下载器
2. Tools → Programmer
3. 选择 output_files/health.sof
4. 点击 Start 开始下载

## 🧪 功能测试

### 测试步骤
1. **上电检查**
   - LED0应该在1秒后点亮（初始化完成）
   - 如果LED1点亮，表示I2C通信错误

2. **测量心率**
   - 将手指轻轻放在MAX30102传感器上
   - 手指覆盖整个传感器区域
   - LED2会闪烁（数据采集中）
   - 保持静止10秒

3. **查看结果**
   - LED3点亮表示心率计算完成
   - 数码管显示心率值（单位：BPM）
   - 正常心率范围：60-100 BPM

### LED状态含义

| LED | 状态 | 说明 |
|-----|------|------|
| LED0 | 常亮 | 初始化成功，系统正常 |
| LED1 | 常亮 | I2C通信错误 |
| LED2 | 闪烁 | 正在采集数据（100Hz） |
| LED3 | 每10秒闪一次 | 心率计算完成 |

## 📊 工作原理

### 数据采集流程
```
1. 系统初始化（1秒）
   ↓
2. 配置MAX30102寄存器
   ↓
3. 等待FIFO中断（INT信号）
   ↓
4. 读取RED和IR通道数据（6字节）
   ↓
5. 峰值检测算法
   ↓
6. 每10秒计算心率（显示在数码管）
```

### MAX30102配置参数
- **工作模式**：SpO2模式（RED+IR双通道）
- **采样率**：100 Hz
- **ADC分辨率**：18位
- **LED脉宽**：411μs
- **LED电流**：7.6 mA
- **FIFO平均**：4次采样平均

## 🔧 故障排除

### 问题1：LED0不亮
**原因**：
- MAX30102未连接或连接错误
- I2C通信失败（无ACK）

**解决方法**：
1. 检查MAX30102供电（3.3V和GND）
2. 检查SCL/SDA连接和上拉电阻
3. 使用万用表测量I2C信号线电平

### 问题2：LED1常亮（错误指示）
**原因**：
- I2C通信ACK错误
- MAX30102地址错误或损坏

**解决方法**：
1. 检查I2C上拉电阻（4.7kΩ）
2. 测试MAX30102模块（更换模块）
3. 使用SignalTap调试I2C时序

### 问题3：数码管无显示或显示乱码
**原因**：
- 数据采集不稳定
- 手指接触不良
- LED电流设置不当

**解决方法**：
1. 确保手指完全覆盖传感器
2. 保持手指和传感器相对静止
3. 等待完整的10秒采集周期
4. 调整LED电流（修改寄存器值）

### 问题4：心率值异常
**数值异常**：
- 太高（>150）：环境光干扰或手指移动
- 太低（<40）：接触不良或血液循环不佳
- 显示0：无有效峰值检测

**解决方法**：
1. 在暗光环境下测量
2. 清洁传感器表面
3. 手指稍微用力按压（不要太紧）
4. 等待多个采集周期取平均值

## 🔍 SignalTap调试

### 建议监测的信号
```verilog
// I2C通信
state           // I2C状态机
scl, sda        // I2C时序
i2c_busy        // I2C忙标志
i2c_ack_err     // ACK错误

// MAX30102
init_done       // 初始化完成
data_valid      // 数据有效
red_data[17:0]  // RED通道数据
ir_data[17:0]   // IR通道数据

// 心率计算
peak_det        // 峰值检测
peak_cnt        // 峰值计数
heart_rate      // 心率值
```

## 📝 配置参数修改

### 修改LED电流（在max30102_driver.v中）
```verilog
// 当前配置：7.6mA
INIT_LED1: i2c_wr_data <= 8'h24;  // RED LED
INIT_LED2: i2c_wr_data <= 8'h24;  // IR LED

// 可选值（0x00-0xFF）：
// 0x00 = 0 mA
// 0x1F = 6.4 mA
// 0x24 = 7.6 mA  ← 当前值
// 0x32 = 10.6 mA
// 0xFF = 51 mA（最大）
```

### 修改采样率（在max30102_driver.v中）
```verilog
// 当前配置：100Hz，18位ADC
INIT_SPO2: i2c_wr_data <= 8'h27;

// SPO2_CONFIG寄存器格式：
// Bit[6:5] = ADC范围
// Bit[4:2] = 采样率
// Bit[1:0] = LED脉宽（ADC分辨率）

// 可选配置：
// 0x27 = 100Hz, 18位  ← 当前值
// 0x2F = 400Hz, 18位（更快响应）
// 0x23 = 100Hz, 16位（降低功耗）
```

## 📚 参考资料

- MAX30102数据手册
- 野火小智心率血氧检测模块规格手册
- README_MAX30102.md（详细技术文档）

## ✅ 检查清单

部署前检查：
- [ ] MAX30102模块已连接到正确引脚
- [ ] SCL/SDA有4.7kΩ上拉电阻
- [ ] 3.3V供电正常
- [ ] 数码管模块已连接
- [ ] Quartus项目编译成功
- [ ] .sof文件已下载到FPGA
- [ ] LED0初始化完成指示灯点亮

测量时检查：
- [ ] 手指完全覆盖传感器
- [ ] 保持手指静止不动
- [ ] 等待至少10秒
- [ ] 观察LED2数据采集指示
- [ ] 数码管显示合理心率值

---
**版本**：V1.0  
**日期**：2025-12-22  
**作者**：Fire
